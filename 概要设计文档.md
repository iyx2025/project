# 家庭食谱与膳食计划应用概要设计文档

## 1. 系统概述

### 1.1 系统定位
家庭食谱与膳食计划应用是一款面向家庭用户的饮食管理桌面应用，旨在帮助用户方便地管理食谱、规划膳食、控制营养摄入，并提供个性化的饮食建议。系统采用Python+Flask+PyQt6+SQLite技术栈，提供本地存储和高效的用户体验。

### 1.2 设计目标
- 构建高性能、可扩展的系统架构
- 提供良好的用户体验和交互设计
- 确保系统的安全性和稳定性
- 实现模块化设计，便于后续功能扩展

## 2. 系统架构设计

### 2.1 整体架构
系统采用桌面应用+本地后端+本地存储的架构模式，主要包括以下几层：

1. **桌面UI层**：使用PyQt6实现，负责用户界面展示和交互
2. **API通信层**：处理桌面UI与后端接口的通信
3. **业务逻辑层**：使用Flask实现，实现核心业务功能和接口
4. **数据访问层**：负责与SQLite数据库交互
5. **数据存储层**：包括SQLite数据库和本地文件存储

### 2.2 技术架构图

```
+---------------------------------------------+
|                桌面UI层                       |
|  +----------------+  +----------------+    |
|  |  PyQt6界面组件 |  |  图表可视化组件  |    |
|  +----------------+  +----------------+    |
|  +----------------+                        |
|  |  多线程管理    |                        |
|  +----------------+                        |
+---------------------------|-----------------+
                           |
+---------------------------v-----------------+
|                API通信层                      |
|  +----------------+  +----------------+    |
|  |  HTTP请求处理  |  |  数据序列化/反序列化 | |
|  +----------------+  +----------------+    |
|  +----------------+                        |
|  |  错误处理      |                        |
|  +----------------+                        |
+---------------------------|-----------------+
                           |
+---------------------------v-----------------+
|                业务逻辑层                      |
|  +----------------+  +----------------+    |
|  |  Flask应用     |  |  路由控制器    |    |
|  +----------------+  +----------------+    |
|  +----------------+  +----------------+    |
|  |  用户服务      |  |  食谱服务       |    |
|  +----------------+  +----------------+    |
|  +----------------+  +----------------+    |
|  |  膳食计划服务  |  |  营养分析服务   |    |
|  +----------------+  +----------------+    |
+---------------------------|-----------------+
                           |
+---------------------------v-----------------+
|                数据访问层                      |
|  +----------------+  +----------------+    |
|  |  SQLAlchemy ORM|  |  数据库连接池   |    |
|  +----------------+  +----------------+    |
+---------------------------|-----------------+
                           |
+---------------------------v-----------------+
|                数据存储层                      |
|  +----------------+  +----------------+    |
|  |  SQLite数据库  |  |  本地文件存储   |    |
|  +----------------+  +----------------+    |
+---------------------------------------------+
```

### 2.3 通信架构
- **桌面UI与后端通信**：采用RESTful API进行本地通信，使用JSON格式传输数据
- **数据加密**：敏感数据本地存储加密，如用户密码采用哈希加密

## 3. 技术选型

### 3.1 桌面UI技术栈

| 类别 | 技术/框架 | 版本 | 选型理由 |
|------|-----------|------|----------|
| UI框架 | PyQt6 | 6.x | 功能强大的跨平台GUI框架，组件丰富，性能优秀，适合构建复杂桌面应用 |
| UI组件 | PyQt6内置组件 | - | 提供丰富的原生UI组件，如按钮、表格、对话框等 |
| 图表库 | PyQt6 Charts/Matplotlib | - | 提供数据可视化能力，支持各种图表展示营养分析数据 |
| HTTP客户端 | Requests | 2.x | 简洁易用的HTTP库，用于与本地Flask API通信 |
| 多线程 | Python threading | - | 用于处理后台任务和API请求，避免UI卡顿 |

### 3.2 后端接口技术栈

| 类别 | 技术/框架 | 版本 | 选型理由 |
|------|-----------|------|----------|
| 开发语言 | Python | 3.9+ | 语法简洁，生态丰富，适合快速开发后端服务 |
| Web框架 | Flask | 2.x | 轻量级Web框架，灵活性高，易于集成，适合构建RESTful API |
| 数据库 | SQLite | 3.x | 轻量级嵌入式数据库，无需额外安装，适合本地存储应用 |
| ORM框架 | SQLAlchemy | 2.x | 功能强大的Python ORM，简化数据库操作，支持SQLite |
| 身份认证 | Flask-JWT-Extended | - | 基于JWT的认证扩展，适合本地应用的用户认证 |
| 数据验证 | Flask-WTF/Marshmallow | - | 用于请求数据验证和序列化，确保数据完整性 |
| 文件存储 | 本地文件系统 | - | 将用户上传的图片等文件存储在本地文件系统中 |

### 3.3 本地部署技术

| 类别 | 技术/工具 | 选型理由 |
|------|-----------|----------|
| 应用打包 | PyInstaller | 将Python应用打包为可执行文件，方便用户安装使用 |
| 依赖管理 | pip/requirements.txt | 管理Python依赖包，确保版本一致性 |
| 数据库初始化 | 脚本化初始化 | 应用首次启动时自动创建和初始化SQLite数据库 |
| 配置管理 | 本地配置文件 | 使用JSON/YAML格式的配置文件，管理应用配置 |

## 4. 模块划分

### 4.1 用户管理模块
- **功能职责**：负责用户注册、登录、个人信息管理、健康信息设置等
- **主要接口**：
  - 用户注册接口
  - 用户登录接口
  - 获取/更新用户信息接口
  - 更新健康信息接口
  - 密码找回接口
- **关键类/函数**：
  - UserService：用户业务逻辑处理
  - AuthService：认证相关业务逻辑
  - UserController：处理用户相关HTTP请求

### 4.2 食谱管理模块
- **功能职责**：负责食谱的增删改查、分类管理、搜索、收藏等
- **主要接口**：
  - 获取食谱列表接口
  - 获取食谱详情接口
  - 创建/更新/删除食谱接口
  - 搜索食谱接口
  - 收藏/取消收藏食谱接口
- **关键类/函数**：
  - RecipeService：食谱业务逻辑处理
  - RecipeController：处理食谱相关HTTP请求
  - SearchService：搜索相关业务逻辑

### 4.3 膳食计划模块
- **功能职责**：负责膳食计划的创建、编辑、查看等
- **主要接口**：
  - 创建膳食计划接口
  - 获取膳食计划列表接口
  - 获取膳食计划详情接口
  - 更新/删除膳食计划接口
  - 添加/移除计划中的食谱接口
- **关键类/函数**：
  - MealPlanService：膳食计划业务逻辑处理
  - MealPlanController：处理膳食计划相关HTTP请求

### 4.4 食材管理模块
- **功能职责**：负责食材库管理、食材清单生成等
- **主要接口**：
  - 获取食材列表接口
  - 获取食材详情接口
  - 生成食材清单接口
  - 更新食材清单接口
  - 管理食材库存接口
- **关键类/函数**：
  - IngredientService：食材业务逻辑处理
  - ShoppingListService：食材清单业务逻辑处理
  - IngredientController：处理食材相关HTTP请求

### 4.5 营养分析模块
- **功能职责**：负责食谱和膳食计划的营养分析、营养目标设置等
- **主要接口**：
  - 分析食谱营养接口
  - 分析膳食计划营养接口
  - 设置营养目标接口
  - 获取营养统计接口
- **关键类/函数**：
  - NutritionService：营养分析业务逻辑处理
  - NutritionController：处理营养分析相关HTTP请求

### 4.6 本地数据管理模块
- **功能职责**：负责本地数据的备份、恢复、导出和导入
- **主要接口**：
  - 数据备份接口
  - 数据恢复接口
  - 数据导出接口（JSON/CSV格式）
  - 数据导入接口
- **关键类/函数**：
  - DataBackupService：数据备份恢复业务逻辑处理
  - DataExportService：数据导出导入业务逻辑处理
  - DataController：处理数据管理相关HTTP请求

## 5. 数据结构设计

### 5.1 核心数据实体

#### 5.1.1 用户(User)
- user_id：用户ID（主键）
- username：用户名
- password：密码（加密存储）
- email：邮箱
- phone：手机号
- avatar：头像URL
- gender：性别
- age：年龄
- height：身高（cm）
- weight：体重（kg）
- dietary_preference：饮食偏好
- health_goal：健康目标
- allergies：过敏原（JSON数组）
- created_at：创建时间
- updated_at：更新时间

#### 5.1.2 食谱(Recipe)
- recipe_id：食谱ID（主键）
- user_id：创建者ID（外键）
- title：标题
- description：描述
- cover_image：封面图片URL
- prep_time：准备时间（分钟）
- cook_time：烹饪时间（分钟）
- servings：份数
- difficulty：难度（简单、中等、困难）
- is_public：是否公开
- is_featured：是否精选
- view_count：浏览次数
- like_count：点赞次数
- comment_count：评论次数
- created_at：创建时间
- updated_at：更新时间

#### 5.1.3 食材(Ingredient)
- ingredient_id：食材ID（主键）
- name：名称
- category：类别
- unit：计量单位
- calories：热量（每100g）
- protein：蛋白质含量（每100g）
- fat：脂肪含量（每100g）
- carbohydrate：碳水化合物含量（每100g）
- vitamins：维生素含量（JSON对象）
- minerals：矿物质含量（JSON对象）

#### 5.1.4 食谱食材(RecipeIngredient)
- recipe_ingredient_id：主键
- recipe_id：食谱ID（外键）
- ingredient_id：食材ID（外键）
- quantity：数量
- unit：单位

#### 5.1.5 食谱步骤(RecipeStep)
- step_id：步骤ID（主键）
- recipe_id：食谱ID（外键）
- step_number：步骤序号
- description：步骤描述
- image_url：步骤图片URL

#### 5.1.6 膳食计划(MealPlan)
- plan_id：计划ID（主键）
- user_id：用户ID（外键）
- title：计划标题
- start_date：开始日期
- end_date：结束日期
- plan_type：计划类型（日、周、月）
- is_template：是否为模板
- created_at：创建时间
- updated_at：更新时间

#### 5.1.7 计划餐次(MealPlanItem)
- item_id：餐次ID（主键）
- plan_id：计划ID（外键）
- meal_date：餐次日期
- meal_type：餐次类型（早餐、午餐、晚餐、加餐）
- recipe_id：食谱ID（外键）
- notes：备注

#### 5.1.8 评论(Comment)
- comment_id：评论ID（主键）
- user_id：用户ID（外键）
- recipe_id：食谱ID（外键）
- content：评论内容
- created_at：创建时间
- updated_at：更新时间

#### 5.1.9 收藏(Favorite)
- favorite_id：收藏ID（主键）
- user_id：用户ID（外键）
- recipe_id：食谱ID（外键）
- created_at：收藏时间

## 6. 接口设计

### 6.1 接口分类
- **用户接口**：用户注册、登录、信息管理等
- **食谱接口**：食谱的增删改查、搜索等
- **膳食计划接口**：膳食计划的创建、编辑、查看等
- **食材接口**：食材库管理、食材清单生成等
- **营养分析接口**：营养分析、目标设置等
- **社区接口**：食谱分享、评论、点赞等

### 6.2 接口规范
- **请求方式**：GET、POST、PUT、DELETE
- **请求参数**：Query参数、Body参数（JSON格式）
- **响应格式**：
  ```json
  {
    "code": 200,
    "message": "success",
    "data": { ... }
  }
  ```
- **错误处理**：统一的错误码和错误消息

## 7. 系统安全设计

### 7.1 身份认证与授权
- 采用JWT进行身份认证
- 实现基于角色的访问控制（RBAC）
- 设置Token过期时间和刷新机制

### 7.2 数据安全
- 敏感数据加密存储（如用户密码）
- 使用HTTPS加密传输数据
- 防止SQL注入、XSS攻击等常见安全漏洞

### 7.3 访问控制
- 实现接口级别的访问控制
- 对敏感操作进行权限验证
- 防止未授权访问

### 7.4 日志与审计
- 记录关键操作日志
- 定期进行安全审计
- 监控异常访问行为

## 8. 系统扩展性设计

### 8.1 模块化设计
- 采用组件化设计思想，实现功能模块解耦
- 定义清晰的模块边界和接口
- 支持功能模块的灵活扩展

### 8.2 数据库扩展性
- 考虑SQLite数据库优化和维护
- 使用连接池优化数据库连接管理
- 针对大数据量操作进行性能优化

### 8.3 功能扩展性
- 设计插件化架构，支持功能模块的动态加载
- 提供开放API，支持第三方应用接入
- 采用事件驱动设计，便于功能扩展

## 9. 性能优化

### 9.1 桌面UI优化
- 组件的按需创建和销毁
- 图片资源优化和缓存
- 多线程处理耗时操作，避免UI卡顿
- 界面响应式设计，适应不同分辨率

### 9.2 后端优化
- 使用缓存减少数据库查询
- 优化SQL查询
- 实现请求限流和熔断机制
- 使用数据库索引优化查询性能

### 9.3 数据库优化
- 合理设计表结构和索引
- 定期进行数据库维护和优化
- 使用数据库连接池管理连接

## 10. 测试策略

### 10.1 单元测试
- 对核心业务逻辑进行单元测试
- 使用pytest等Python测试框架

### 10.2 集成测试
- 测试各模块之间的交互
- 测试API接口的正确性

### 10.3 性能测试
- 测试系统在高并发下的性能
- 测试系统的响应时间和吞吐量

### 10.4 安全测试
- 进行渗透测试和安全扫描
- 测试系统的安全性和防御能力

## 11. 部署架构

### 11.1 开发环境
- Python虚拟环境配置
- 本地Flask开发服务器
- SQLite数据库

### 11.2 测试环境
- 模拟不同操作系统环境
- 不同分辨率和屏幕尺寸测试

### 11.3 生产环境
- 打包为桌面可执行文件
- 自动数据库初始化和迁移
- 本地文件存储管理

## 12. 文档与交付物

### 12.1 开发文档
- 需求说明书
- 概要设计文档
- 详细设计文档
- 数据库设计文档
- API接口文档

### 12.2 部署文档
- 环境配置文档
- 部署指南
- 运维手册

### 12.3 用户文档
- 用户手册
- 操作指南
- 常见问题解答